# Frago Development Guidelines

## LAW
- Code, Docs, Comments MUST writing in English
- Docs in Chinese must creat new file naming as `-zhCN`

## Document Maintenance Principles

This file is only used to guide Claude Code in iterating the repository code, with content limited to:
- Project directory structure
- Resource update workflow and prohibited operations
- Technical preferences during development

Should NOT include:
- Frago product usage instructions, command reference, or API documentation
- Behavioral specifications for Agents using frago tools
- Version numbers, dependency lists, or other information obtainable from pyproject.toml

## Directory Structure

```
src/frago/              # Core code
src/frago/resources/    # PyPI package resources (generated by dev pack)
```

## Target Audience for the Final Product
- Some developers: frago can effectively enhance technical research/API documentation interpretation/experimental development, suitable for developers who enjoy and value this type of work
- Regular users seeking automation: Most of these users don't have extensive technical experience and cannot figure out the key technical solutions, dependencies, and implementations used in our project
Therefore, it is **essential** to:
1. Provide sufficient, comprehensive, accessible, and easy-to-understand help and documentation;
2. People care about what's best, not the rigid "Option 1", "Option 2" that technical developers prefer, unless absolutely necessary to show differences. Project documentation and Tips must provide the best choice, not "you can do this or that."
3. Always think and implement "best practices" based on "whether users can easily understand this."

## Cross-Platform Development Considerations

The project must support Linux/macOS/Windows simultaneously, with Windows having the most differences.

### Command Line Arguments

Windows command line arguments get truncated at newlines; multi-line text should be passed via stdin or temp files:

```python
# Wrong: multi-line prompt will be truncated
subprocess.run(["claude", "-p", multi_line_prompt])

# Correct: use stdin
process = subprocess.Popen(["claude", "-p", "-"], stdin=subprocess.PIPE)
process.stdin.write(prompt.encode())
process.stdin.close()

# Correct: use temp file
prompt_file.write_text(prompt)
subprocess.run(["frago", "agent", "--prompt-file", str(prompt_file)])
```

### Path Encoding

Claude Code encodes project paths as directory names; Windows drive letters require special handling:

| Original Path | Encoded Result |
|---------------|----------------|
| `/home/user/project` | `-home-user-project` |
| `C:\Users\yammi` | `C--Users-yammi` |

Key: Windows `:` is converted to `-`, producing double hyphen `C--`. See `encode_project_path` and `decode_project_path` in `frago/session/sync.py`.

### subprocess Calls

Use `frago.compat.prepare_command_for_windows` to handle npm global commands:

```python
from frago.compat import prepare_command_for_windows

# Automatically resolves full path to claude.CMD
subprocess.run(prepare_command_for_windows(["claude", "-p", "test"]))
```

### Encoding Issues

Windows console defaults to non-UTF-8; subprocess calls need explicit specification:

```python
subprocess.run(cmd, text=True, encoding='utf-8')
```

### Null Device Redirection

**Prohibited**: hardcoding `/dev/null` in code - on Windows this creates an actual file named `nul`.

```python
import os
import platform

# Correct: cross-platform null device
NULL_DEVICE = 'nul' if platform.system() == 'Windows' else '/dev/null'

# Or use subprocess.DEVNULL
subprocess.run(cmd, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
```

When executing shell commands, prefer `subprocess.DEVNULL` over redirect strings.

## Resources Unified to User Directory

All resources are stored in user directory:

```
~/.claude/
├── commands/
│   ├── frago.*.md       # Frago commands
│   └── frago/           # Command rules and scripts
└── skills/
    └── frago-*/         # Frago skills

~/.frago/
├── config.json          # Global configuration
├── current_run          # Current run context
├── projects/            # Run instance directory
├── recipes/             # Recipe library
│   ├── atomic/
│   └── workflows/
├── sessions/            # Session storage
└── chrome_profile/      # Chrome configuration
```

## Resource Update Workflow

```
~/.claude/commands/frago.*.md  ──┐
~/.claude/skills/frago-*       ──┼──→  frago dev pack  ──→  src/frago/resources/
~/.frago/recipes/              ──┘
```

## Prohibited Actions

- ❌ Directly modify `src/frago/resources/` (auto-generated by dev pack)
- ✅ Edit resources in `~/.claude/` and `~/.frago/`, then sync via `frago dev pack`

## Documentation Index (Read as Needed)

| Document | Purpose |
|----------|---------|
| `docs/concepts.md` | Core concepts and architecture design |
| `pyproject.toml` | Dependency versions, entry point configuration |
| `specs/*/spec.md` | Specifications for each feature |
| `~/.claude/commands/frago/` | Behavioral specifications for Agents using frago |
