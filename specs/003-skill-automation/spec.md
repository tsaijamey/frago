# Feature Specification: 技能自动化生成系统

**Feature Branch**: `003-skill-automation`
**Created**: 2025-11-18
**Status**: Draft
**Input**: 通过自然语言指令生成可复用的操作技能脚本

## 澄清

### 会话 2025-11-18

- Q: 为避免与Claude Code的"skills"语义冲突，应该使用什么目录名称来存储自动生成的可复用脚本？ → A: recipes/
- Q: 在扁平的 `recipes/` 目录中，脚本文件名应该遵循什么命名约定来确保AI和人类都能快速理解其用途？ → A: 使用平台/网站前缀（如 `youtube_extract_subtitles.js`、`github_clone_repo_info.js`）
- Q: 当对配方脚本进行迭代更新时，应该如何管理版本以保留历史并识别最新版本？ → A: 覆盖原文件并在知识文档中记录历史，文件名保持不变，版本信息仅在.md中体现
- Q: 知识文档应该包含哪些固定章节以确保信息完整且结构一致？ → A: 标准6章节 - 功能描述、使用方法、前置条件、预期输出、注意事项、更新历史
- Q: 当探索过程中无法定位关键元素或页面结构过于复杂导致探索失败时，系统应该如何处理？ → A: 交互式引导 - 探索失败时暂停，实时向用户询问下一步操作或提供候选元素让用户选择

### 补充说明

**用户交互接口**: 通过 `/auvima.recipe` 命令提供场景化的配方管理入口：
- `/auvima.recipe create "操作描述"` - 创建新配方
- `/auvima.recipe update <配方名> "问题描述"` - 更新配方
- `/auvima.recipe list` - 列出所有配方

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 通过自然语言指令创建快捷操作脚本 (Priority: P1)

Claude Code接收用户提供的操作步骤描述，通过与Chrome CDP交互进行实际操作探索，理解操作流程，并生成一个可复用的JavaScript脚本。这个脚本可以在将来通过 `uv run auvima exe_js` 命令直接执行，无需再次描述步骤。

**Why this priority**: 这是核心功能，是整个系统的基础价值所在——将复杂的多步骤操作转化为可复用的自动化脚本，节省用户重复劳动的时间。

**Independent Test**: 用户提供"在YouTube视频页面获取字幕内容"的步骤描述，系统能够生成 `youtube_extract_subtitles.js` 脚本，执行该脚本后能够成功提取字幕并输出结果。

**Acceptance Scenarios**:

1. **Given** 用户提供操作步骤描述"在当前YouTube视频页面点击更多按钮，点击显示完整字幕选项，复制字幕文本"，**When** Claude Code执行探索流程，**Then** 系统生成包含DOM选择器和点击逻辑的JavaScript脚本，并保存到指定目录
2. **Given** 已生成的 `youtube_extract_subtitles.js` 脚本存在于配方目录，**When** 用户在打开YouTube视频后执行 `uv run auvima exe_js recipes/youtube_extract_subtitles.js`，**Then** 脚本成功提取字幕内容并返回结果
3. **Given** 用户提供的步骤描述不够明确（缺少关键元素定位信息），**When** Claude Code开始探索，**Then** 系统主动询问澄清问题（例如："需要点击的按钮的文本内容或位置是什么？"）
4. **Given** 探索过程中发现DOM结构与描述不匹配，**When** Claude Code尝试定位元素失败，**Then** 系统暂停探索，展示候选元素列表或截图，引导用户选择正确元素或描述下一步操作

---

### User Story 2 - 将生成的脚本整理为知识文档 (Priority: P2)

系统不仅生成可执行脚本，还为每个技能创建配套的知识文档，记录脚本的用途、适用场景、输入输出、依赖条件和注意事项，便于后续查找和使用。

**Why this priority**: 知识管理是让技能库真正有价值的关键。没有文档的脚本很快会被遗忘或误用，文档确保了技能的可维护性和可传承性。

**Independent Test**: 生成 `youtube_extract_subtitles.js` 脚本后，系统自动创建 `youtube_extract_subtitles.md` 文档，文档包含清晰的使用说明、前置条件、预期输出和常见问题。

**Acceptance Scenarios**:

1. **Given** 系统成功生成配方脚本，**When** 脚本保存完成，**Then** 自动在同一目录生成对应的Markdown文档，包含标准6章节：功能描述、使用方法、前置条件、预期输出、注意事项、更新历史（初始为空）
2. **Given** 文档模板定义了标准章节结构，**When** 生成知识文档，**Then** 文档内容自动填充各章节，包括从用户原始描述提取的使用场景和从探索过程提取的技术细节
3. **Given** 用户在技能目录中查找可用脚本，**When** 查看脚本对应的Markdown文档，**Then** 能够快速理解脚本功能、判断是否适用当前场景、了解如何正确使用

---

### User Story 3 - 脚本版本管理和迭代优化 (Priority: P3)

当用户发现某个技能脚本在新场景中失效或需要改进时，可以通过自然语言描述问题或新需求，系统基于现有脚本进行迭代，生成改进版本并更新知识文档。

**Why this priority**: 技能脚本需要随着目标网站或应用的变化而更新。迭代优化能力确保技能库保持活力和准确性，避免脚本过时失效。

**Independent Test**: 用户反馈"YouTube改版后字幕按钮的选择器失效"，系统重新探索页面，更新 `youtube_extract_subtitles.js` 脚本中的选择器，并在文档中记录更新历史。

**Acceptance Scenarios**:

1. **Given** 用户执行某个配方脚本时遇到错误，**When** 用户提供错误描述和改进需求，**Then** 系统加载原有脚本，重新探索目标页面，覆盖原文件生成更新版本
2. **Given** 配方脚本被更新，**When** 更新完成，**Then** 知识文档自动在"更新历史"章节添加新条目，记录更新日期、原因和主要变更
3. **Given** 多次迭代后配方脚本被更新多次，**When** 用户查看知识文档，**Then** 能够在"更新历史"章节看到完整的版本演进记录

---

### Edge Cases

- **网站结构频繁变化**：当目标网站（如YouTube、Twitter）频繁改版导致DOM结构变化时，如何减少脚本失效频率？建议使用更稳定的定位策略（如ARIA标签、data属性），并在文档中标注脆弱性
- **动态加载内容**：当页面内容通过AJAX动态加载时，如何确保脚本等待元素出现后再操作？系统应在探索过程中检测异步加载模式，并在生成的脚本中加入适当的等待逻辑
- **探索过程中断**：在交互式引导过程中，如果用户多次无法提供有效信息或选择，如何优雅地终止探索？系统应在3次无效交互后建议用户重新整理需求，并保存已探索到的部分信息
- **多页面流程**：当操作步骤跨越多个页面或标签页时，如何管理页面切换和上下文？系统应支持多步骤流程，并在脚本中明确标注页面切换点
- **权限和登录状态**：某些操作需要用户已登录或具有特定权限，如何在脚本中处理这些前置条件？知识文档应明确列出前置条件，脚本应包含状态检查逻辑
- **脚本命名冲突**：当用户创建多个功能相似的技能时，如何避免命名冲突和混淆？系统应建议基于场景的命名规范，并在创建前检查重复
- **执行环境差异**：相同的脚本在不同浏览器窗口尺寸、缩放比例或网络速度下可能表现不同，如何提高脚本的鲁棒性？在探索过程中测试多种条件，并在文档中记录已知限制

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须接收用户以自然语言形式提供的操作步骤描述，作为技能生成的输入
- **FR-002**: 系统必须能够通过Chrome CDP连接到已打开的浏览器实例，执行探索性操作以理解用户描述的步骤
- **FR-003**: 系统必须在探索过程中使用现有的CDP工具（如 `cdp_screenshot.sh`、`cdp_click.sh`、`cdp_exec_js.sh`）进行页面交互
- **FR-004**: 系统必须能够从探索过程中提取DOM结构信息、元素选择器、操作序列，并将其转化为可执行的JavaScript代码
- **FR-005**: 系统必须将生成的JavaScript脚本保存到 `src/auvima/recipes/` 目录中，文件名遵循"平台前缀_功能描述"格式（例如 `youtube_extract_subtitles.js`、`github_clone_repo_info.js`），使用小写字母和下划线分隔
- **FR-006**: 系统必须为每个生成的配方脚本创建配套的Markdown知识文档，包含以下标准6章节：功能描述、使用方法、前置条件、预期输出、注意事项、更新历史
- **FR-007**: 生成的配方脚本必须能够通过 `uv run auvima exe_js <脚本路径>` 命令独立执行，无需额外的上下文或参数（或在文档中明确说明所需参数）
- **FR-008**: 系统必须在探索过程中遇到歧义或不确定性时，主动向用户提出澄清问题，确保生成的脚本准确反映用户意图
- **FR-013**: 当探索过程中无法定位关键元素时，系统必须暂停探索，通过截图或列出候选元素的方式实时引导用户选择或描述正确的操作目标
- **FR-009**: 系统必须支持对现有配方脚本的迭代更新，基于用户反馈的问题或新需求重新探索并覆盖原文件生成改进版本
- **FR-010**: 系统必须在知识文档的"更新历史"章节记录每次更新，包括更新日期、原因和主要变更内容，文件名保持不变
- **FR-011**: 生成的配方脚本必须包含错误处理逻辑，当关键元素未找到或操作失败时，返回清晰的错误信息
- **FR-012**: 系统必须在生成脚本前检查目标目录中是否存在同名文件，如存在则询问用户是否覆盖更新（并记录到更新历史）还是取消操作

### Key Entities

- **配方脚本（Recipe Script）**：存储在 `src/auvima/recipes/` 目录中的JavaScript文件，包含可复用的自动化操作逻辑。属性包括：文件名（遵循平台前缀约定）、创建日期、依赖的CDP功能、适用场景
- **知识文档（Knowledge Document）**：与配方脚本配套的Markdown文件，记录脚本的使用说明、前置条件、输出格式、注意事项和更新历史。更新历史章节包含每次迭代的日期、原因和变更内容
- **操作步骤描述（Operation Description）**：用户提供的自然语言输入，描述要实现的操作流程，包含目标页面、交互元素、期望结果
- **探索会话（Exploration Session）**：Claude Code与Chrome CDP交互的过程记录，包括执行的CDP命令、获取的页面信息、发现的DOM结构、遇到的问题和解决方案
- **配方库（Recipe Library）**：所有已生成配方脚本和知识文档的集合，以扁平的文件系统目录形式组织，通过描述性文件名区分用途

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户能够在5分钟内通过自然语言描述生成一个可执行的配方脚本，无需手动编写任何代码
- **SC-002**: 生成的配方脚本在相同页面条件下执行成功率达到90%以上（即10次执行中至少9次成功完成操作）
- **SC-003**: 每个配方脚本的知识文档必须包含标准6章节（功能描述、使用方法、前置条件、预期输出、注意事项、更新历史），且内容完整可读
- **SC-004**: 用户能够在配方库中通过文档快速找到所需脚本，查找和理解一个配方脚本的时间不超过2分钟
- **SC-005**: 当目标网站DOM结构发生变化导致脚本失效时，用户能够在10分钟内通过系统迭代功能生成更新版本，恢复脚本可用性
- **SC-006**: 配方库中的脚本数量增长到20个以上时，仍然能够保持良好的组织结构和可维护性（通过描述性文件名和完整文档）
- **SC-007**: 探索过程中系统提出的澄清问题数量平均不超过3个，确保用户交互负担可控
- **SC-008**: 生成的配方脚本平均代码行数控制在50-200行之间，保持简洁性和可读性
